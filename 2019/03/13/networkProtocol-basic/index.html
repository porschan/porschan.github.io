<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="porschan,710437653@qq.com"><title>网络协议 - 基础知识点 · chanchifeng</title><meta name="description" content="笔记区域，未整理1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757"><meta name="keywords" content="Hexo,HTML,CSS,android,Linux"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">chanchifeng</a></h3><div class="description"><p>Carpet Diem</p></div></div></div><ul class="social-links"><li><a href="http://github.com/porschan"><i class="fa fa-github"></i></a></li></ul><div class="footer"></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li><li><a href="/readme">引导</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>网络协议 - 基础知识点</a></h3></div><div class="post-content"><h3 id="笔记区域，未整理"><a href="#笔记区域，未整理" class="headerlink" title="笔记区域，未整理"></a>笔记区域，未整理</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><span class="line">只有通过这种协议，计算机才知道我们想让它做什么。</span><br><span class="line"></span><br><span class="line">编译过程：</span><br><span class="line">源文件 -&gt; 词法分析 -&gt; 语法分析 -&gt; 语义分析 -&gt; 代码生成 -&gt; 目标文件</span><br><span class="line"></span><br><span class="line">协议三要素：</span><br><span class="line">语法，就是这一段内容要符合一定的规则和格式。</span><br><span class="line">语义，就是这一段内容要代表某种意义。</span><br><span class="line">顺序。</span><br><span class="line"></span><br><span class="line">只有通过网络协议，才能使一大片机器互相协作、共同完成一件事。</span><br><span class="line"></span><br><span class="line">除了DNS还有一个更加精准的HTTPDNS</span><br><span class="line"></span><br><span class="line">DNS、HTTP、HTTPS所在的层我们称为应用层。</span><br><span class="line"></span><br><span class="line">传输层有两种协议，一种是无连接的协议UDP，一种是面向连接的协议TCP。</span><br><span class="line"></span><br><span class="line">传输层封装完毕后，浏览器会将包交给操作系统的网络层。网络层的协议是IP协议。在IP协议里面会有源IP地址，即浏览器所在机器的IP地址和目标IP地址。</span><br><span class="line"></span><br><span class="line">而操作系统启动的时候，就会被DHCP协议配置IP地址，以及默认的网关的IP地址192.168.1.1。</span><br><span class="line"></span><br><span class="line">MAC地址。</span><br><span class="line"></span><br><span class="line">ARP协议。</span><br><span class="line"></span><br><span class="line">路由表。	</span><br><span class="line"></span><br><span class="line">路由协议，常用的有OSPF和BGP。</span><br><span class="line"></span><br><span class="line">应用层：DHCP、HTTP、HTTPS、RTMP、P2P、DNS、GTP、RPC</span><br><span class="line"></span><br><span class="line">传输层：UDP、TCP</span><br><span class="line"></span><br><span class="line">网络层：ICMP、IP、OSPF、BGP、IPSec、GRE</span><br><span class="line"></span><br><span class="line">链路层：ARP、VLAN、STP</span><br><span class="line"></span><br><span class="line">物理层：网络跳线</span><br><span class="line"></span><br><span class="line">为什么网络要分层呀？因为不同的层次之间有不同的沟通方式，这个叫作协议。</span><br><span class="line"></span><br><span class="line">IP协议里面包含目标地址和源地址。</span><br><span class="line"></span><br><span class="line">复杂的程序都要分层，这是程序设计的要求。</span><br><span class="line"></span><br><span class="line">所有不能表示出层层封装含义的比喻，都是不恰当的。</span><br><span class="line"></span><br><span class="line">只要是在网络上跑的包，都是完整的。可以有下层没上层，绝对不可能有上层没下层。</span><br><span class="line"></span><br><span class="line">对TCP协议来说，三次握手也好，重试也好，只要想发出去包，就要有IP层和MAC层，不然是发不出去的。</span><br><span class="line"></span><br><span class="line">什么叫二层设备呀，就是只把MAC头摘下来，看看到底是丢弃、转发，还是自己留着。那什么叫三层设备呢？就是把MAC头摘下来之后，再把IP头摘下来，看看到底是丢弃、转发，还是自己留着。</span><br><span class="line"></span><br><span class="line">IP地址是一个网卡在网络世界的通讯地址，相当于我们现实世界的门牌号码。</span><br><span class="line"></span><br><span class="line">在网络地址中，至少在当时设计的时候，对于A、B、 C类主要分两部分，前面一部分是网络号，后面一部分是主机号。</span><br><span class="line"></span><br><span class="line">于是有了一个折中的方式叫作无类型域间选路，简称CIDR。</span><br><span class="line"></span><br><span class="line">这种方式打破了原来设计的几类地址的做法，将32位的IP地址一分为二，前面是网络号，后面是主机号。</span><br><span class="line"></span><br><span class="line">你如果注意观察的话可以看到，10.100.122.2/24，这个IP地址中有一个斜杠，斜杠后面有个数字24。这种地址表示形式，就是CIDR。后面24的意思是，32位中，前24位是网络号，后8位是主机号。</span><br><span class="line"></span><br><span class="line">伴随着CIDR存在的，一个是广播地址，10.100.122.255。如果发送这个地址，所有10.100.122网络里面的机器都可以收到。另一个是子网掩码，255.255.255.0。</span><br><span class="line"></span><br><span class="line">将子网掩码和IP地址进行AND计算。前面三个255，转成二进制都是1。1和任何数值取AND，都是原来数值，因而前三个数不变，为10.100.122。后面一个0，转换成二进制是0，0和任何数值取AND，都是0，因而最后一个数变为0，合起来就是10.100.122.0。这就是网络号。将子网掩码和IP地址按位计算AND，就可得到网络号。</span><br><span class="line"></span><br><span class="line">不需要将十进制转换为二进制32位，就能明显看出192.168.0是网络号，后面是主机号。而整个网络里面的第一个地址192.168.0.1，往往就是你这个私有网络的出口地址。例如，你家里的电脑连接Wi-Fi，Wi-Fi路由器的地址就是192.168.0.1，而192.168.0.255就是广播地址。一旦发送这个地址，整个192.168.0网络里面的所有机器都能收到。</span><br><span class="line"></span><br><span class="line">我们来看16.158.165.91/22这个CIDR。求一下这个网络的第一个地址、子网掩码和广播地址。</span><br><span class="line"></span><br><span class="line">你要是上来就写16.158.165.1，那就大错特错了。</span><br><span class="line"></span><br><span class="line">/22不是8的整数倍，不好办，只能先变成二进制来看。16.158的部分不会动，它占了前16位。中间的165，变为二进制为10100101。除了前面的16位，还剩6位。所以，这8位中前6位是网络号，16.158.&lt;101001&gt;，而&lt;01&gt;.91是机器号。</span><br><span class="line"></span><br><span class="line">第一个地址是16.158.&lt;101001&gt;&lt;00&gt;.1，即16.158.164.1。子网掩码是255.255.&lt;111111&gt;&lt;00&gt;.0，即255.255.252.0。广播地址为16.158.&lt;101001&gt;&lt;11&gt;.255，即16.158.167.255。</span><br><span class="line"></span><br><span class="line">D类是组播地址。使用这一类地址，属于某个组的机器都能收到。</span><br><span class="line"></span><br><span class="line">在IP地址的后面有个scope，对于eth0这张网卡来讲，是global，说明这张网卡是可以对外的，可以接收来自各个地方的包。对于lo来讲，是host，说明这张网卡仅仅可以供本机相互通信。</span><br><span class="line"></span><br><span class="line">lo全称是loopback，又称环回接口，往往会被分配到127.0.0.1这个地址。这个地址用于本机通信，经过内核处理后直接返回，不会在任何网络中出现。</span><br><span class="line"></span><br><span class="line">在IP地址的上一行是link/ether fa:16:3e:c7:79:75 brd ff:ff:ff:ff:ff:ff，这个被称为MAC地址，是一个网卡的物理地址，用十六进制，6个byte表示。</span><br><span class="line"></span><br><span class="line"> 一个网络包要从一个地方传到另一个地方，除了要有确定的地址，还需要有定位功能。 而有门牌号码属性的IP地址，才是有远程定位功能的。</span><br><span class="line"></span><br><span class="line">MAC地址更像是身份证，是一个唯一的标识。它的唯一性设计是为了组网的时候，不同的网卡放在一个网络里面的时候，可以不用担心冲突。从硬件角度，保证不同的网卡有不同的标识。</span><br><span class="line"></span><br><span class="line">解析完了MAC地址，我们再来看 &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;是干什么的？这个叫作net_device flags，网络设备的状态标识。</span><br><span class="line"></span><br><span class="line">UP表示网卡处于启动的状态；BROADCAST表示这个网卡有广播地址，可以发送广播包；MULTICAST表示网卡可以发送多播包；LOWER_UP表示L1是启动的，也即网线插着呢。MTU1500是指什么意思呢？是哪一层的概念呢？最大传输单元MTU为1500，这是以太网的默认值。</span><br><span class="line"></span><br><span class="line">MTU是二层MAC层的概念。MAC层有MAC的头，以太网规定连MAC头带正文合起来，不允许超过1500个字节。正文里面有IP的头、TCP的头、HTTP的头。如果放不下，就需要分片来传输。</span><br><span class="line"></span><br><span class="line">qdisc pfifo_fast是什么意思呢？qdisc全称是queueing discipline，中文叫排队规则。内核如果需要通过某个网络接口发送数据包，它都需要按照为这个接口配置的qdisc（排队规则）把数据包加入队列。</span><br><span class="line"></span><br><span class="line">最简单的qdisc是pfifo，它不对进入的数据包做任何的处理，数据包采用先入先出的方式通过队列。pfifo_fast稍微复杂一些，它的队列包括三个波段（band）。在每个波段里面，使用先进先出规则。</span><br><span class="line"></span><br><span class="line">三个波段（band）的优先级也不相同。band 0的优先级最高，band 2的最低。如果band 0里面有数据包，系统就不会处理band 1里面的数据包，band 1和band 2之间也是一样。</span><br><span class="line"></span><br><span class="line">数据包是按照服务类型（Type of Service，TOS）被分配到三个波段（band）里面的。TOS是IP头里面的一个字段，代表了当前的包是高优先级的，还是低优先级的。</span><br><span class="line"></span><br><span class="line">Linux首先会判断，要去的这个地址和我是一个网段的吗，或者和我的一个网卡是同一网段的吗？只有是一个网段的，它才会发送ARP请求，获取MAC地址。</span><br><span class="line"></span><br><span class="line">Linux默认的逻辑是，如果这是一个跨网段的调用，它便不会直接将包发送到网络上，而是企图将包发送到网关。</span><br><span class="line"></span><br><span class="line">不同系统的配置文件格式不同，但是无非就是CIDR、子网掩码、广播地址和网关地址。</span><br><span class="line"></span><br><span class="line">动态主机配置协议（Dynamic Host Configuration Protocol），简称DHCP。</span><br><span class="line"></span><br><span class="line">先吼一句，我来啦，有人吗？这时候的沟通基本靠“吼”。这一步，我们称为DHCP Discover。</span><br><span class="line"></span><br><span class="line">新来的机器使用IP地址0.0.0.0发送了一个广播包，目的IP地址为255.255.255.255。广播包封装了UDP，UDP封装了BOOTP。其实DHCP是BOOTP的增强版，但是如果你去抓包的话，很可能看到的名称还是BOOTP协议。</span><br><span class="line"></span><br><span class="line">只有MAC唯一，IP管理员才能知道这是一个新人，需要租给它一个IP地址，这个过程我们称为DHCP Offer。同时，DHCP Server为此客户保留为它提供的IP地址，从而不会为其他DHCP客户分配此IP地址。</span><br><span class="line"></span><br><span class="line">当DHCP Server接收到客户机的DHCP request之后，会广播返回给客户机一个DHCP ACK消息包，表明已经接受客户机的选择，并将这一IP地址的合法租用信息和其他的配置信息都放入该广播包，发给客户机，欢迎它加入网络大家庭。</span><br><span class="line"></span><br><span class="line">客户机会在租期过去50%的时候，直接向为其提供IP地址的DHCP Server发送DHCP request消息包。客户机接收到该服务器回应的DHCP ACK消息包，会根据包中所提供的新的租期以及其他已经更新的TCP/IP参数，更新自己的配置。这样，IP租用更新就完成了。</span><br><span class="line"></span><br><span class="line">预启动执行环境（Pre-boot Execution Environment），简称PXE。</span><br><span class="line"></span><br><span class="line">首先，启动BIOS。这是一个特别小的小系统，只能干特别小的一件事情。其实就是读取硬盘的MBR启动扇区，将GRUB启动起来；然后将权力交给GRUB，GRUB加载内核、加载作为根文件系统的initramfs文件；然后将权力交给内核；最后内核启动，初始化整个操作系统。</span><br><span class="line"></span><br><span class="line">IP层要封装了MAC层才能将包放入物理层。</span><br><span class="line"></span><br><span class="line">两台电脑已经构成了一个最小的局域网，也即LAN。</span><br><span class="line"></span><br><span class="line">有一个叫作Hub的东西，也就是集线器。</span><br><span class="line"></span><br><span class="line">MAC的全称是Medium Access Control，即媒体访问控制。</span><br><span class="line"></span><br><span class="line">多路访问。</span><br><span class="line"></span><br><span class="line">分多个车道。每个车一个车道，你走你的，我走我的。这在计算机网络里叫作信道划分。</span><br><span class="line"></span><br><span class="line">今天单号出行，明天双号出行，轮着来。这在计算机网络里叫作轮流协议。</span><br><span class="line"></span><br><span class="line">不管三七二十一，有事儿先出门，发现特堵，就回去。错过高峰再出。我们叫作随机接入协议。著名的以太网，用的就是这个方式。</span><br><span class="line"></span><br><span class="line">这里用到一个物理地址，叫作链路层地址。但是因为第二层主要解决媒体接入控制的问题，所以它常被称为MAC地址。</span><br><span class="line"></span><br><span class="line">接下来是类型，大部分的类型是IP数据包，然后IP里面包含TCP、UDP，以及HTTP等，这都是里层封装的事情。</span><br><span class="line"></span><br><span class="line">有了这个目标MAC地址，数据包在链路上广播，MAC的网卡才能发现，这个包是给它的。MAC的网卡把包收进来，然后打开IP包，发现IP地址也是自己的，再打开TCP包，发现端口是自己，也就是80，而nginx就是监听80。</span><br><span class="line"></span><br><span class="line">对于以太网，第二层的最后面是CRC，也就是循环冗余检测。</span><br><span class="line"></span><br><span class="line">通过XOR异或的算法，来计算整个包是否在发送的过程中出现了错误。</span><br><span class="line"></span><br><span class="line">这就是ARP协议，也就是已知IP地址，求MAC地址的协议。</span><br><span class="line"></span><br><span class="line">一台MAC1电脑将一个包发送给另一台MAC2电脑，当这个包到达交换机的时候，一开始交换机也不知道MAC2的电脑在哪个口，所以没办法，它只能将包转发给除了来的那个口之外的其他所有的口。但是，这个时候，交换机会干一件非常聪明的事情，就是交换机会记住，MAC1是来自一个明确的口。以后有包的目的地址是MAC1的，直接发送到这个口就可以了。</span><br><span class="line"></span><br><span class="line">当然，每个机器的IP地址会变，所在的口也会变，因而交换机上的学习的结果，我们称为转发表，是有一个过期时间的。</span><br><span class="line"></span><br><span class="line">MAC层是用来解决多路访问的堵车问题的。</span><br><span class="line"></span><br><span class="line">ARP是通过吼的方式来寻找目标MAC地址的，吼完之后记住一段时间，这个叫作缓存。</span><br><span class="line"></span><br><span class="line">交换机是有MAC地址学习能力的，学完了它就知道谁在哪儿了，不用广播了。</span><br><span class="line"></span><br><span class="line">这个时候，一个交换机肯定不够用，需要多台交换机，交换机之间连接起来，就形成一个稍微复杂的拓扑结构。</span><br><span class="line"></span><br><span class="line">环路问题。</span><br><span class="line"></span><br><span class="line">在数据结构中，有一个方法叫作最小生成树。有环的我们常称为图。将图中的环破了，就生成了树。在计算机网络中，生成树的算法叫作STP，全称Spanning Tree Protocol。</span><br><span class="line"></span><br><span class="line">STP协议里面有很多概念：</span><br><span class="line"></span><br><span class="line">Root Bridge，也就是根交换机。</span><br><span class="line"></span><br><span class="line">Designated Bridges，有的翻译为指定交换机。</span><br><span class="line"></span><br><span class="line">Bridge Protocol Data Units （BPDU） ，网桥协议数据单元。</span><br><span class="line"></span><br><span class="line">Priority Vector，优先级向量。</span><br><span class="line">就是一组ID数目，[Root Bridge ID, Root Path Cost, Bridge ID, and Port ID]。</span><br><span class="line"></span><br><span class="line">物理隔离。</span><br><span class="line"></span><br><span class="line">虚拟隔离，就是用我们常说的VLAN，或者叫虚拟局域网。</span><br><span class="line"></span><br><span class="line">我们只需要在原来的二层的头上加一个TAG，里面有一个VLAN ID，一共12位。</span><br><span class="line"></span><br><span class="line">因为12位可以划分4096个VLAN。</span><br><span class="line"></span><br><span class="line">而且对于交换机来讲，每个VLAN的口都是可以重新设置的。一个财务走了，把他所在的作为的口从VLAN 30移除掉，来了一个程序员，坐在财务的位置上，就把这个口设置为VLAN 10，十分灵活。</span><br><span class="line"></span><br><span class="line">对于支持VLAN的交换机，有一种口叫作Trunk口。它可以转发属于任何VLAN的口。交换机之间可以通过这种口相互连接。</span><br><span class="line"></span><br><span class="line">当交换机的数目越来越多的时候，会遭遇环路问题，让网络包迷路，这就需要使用STP协议，通过华山论剑比武的方式，将有环路的图变成没有环路的树，从而解决环路问题。</span><br><span class="line"></span><br><span class="line">交换机数目多会面临隔离问题，可以通过VLAN形成虚拟局域网，从而解决广播问题和安全问题。</span><br><span class="line"></span><br><span class="line">ping是基于ICMP协议工作的。ICMP全称Internet Control Message Protocol，就是互联网控制报文协议。</span><br><span class="line"></span><br><span class="line">ICMP报文是封装在IP包里面的。因为传输指令的时候，肯定需要源地址和目标地址。</span><br><span class="line"></span><br><span class="line">最常用的类型是主动请求为8，主动请求的应答为0。</span><br><span class="line"></span><br><span class="line">这种是主帅发起的，主动查看敌情，对应ICMP的查询报文类型。例如，常用的ping就是查询报文，是一种主动请求，并且获得主动应答的ICMP协议。所以，ping发的包也是符合ICMP协议格式的，只不过它在后面增加了自己的格式。</span><br><span class="line"></span><br><span class="line">对ping的主动请求，进行网络抓包，称为ICMP ECHO REQUEST。同理主动请求的回复，称为ICMP ECHO REPLY。比起原生的ICMP，这里面多了两个字段，一个是标识符。这个很好理解，你派出去两队侦查兵，一队是侦查战况的，一队是去查找水源的，要有个标识才能区分。另一个是序号，你派出去的侦查兵，都要编个号。如果派出去10个，回来10个，就说明前方战况不错；如果派出去10个，回来2个，说明情况可能不妙。</span><br><span class="line"></span><br><span class="line">在选项数据中，ping还会存放发送请求的时间值，来计算往返时间，说明路程的长短。</span><br><span class="line"></span><br><span class="line">差错报文。</span><br><span class="line"></span><br><span class="line">终点不可达为3，源抑制为4，超时为11，重定向为5。</span><br><span class="line"></span><br><span class="line">第一种是终点不可达。具体的原因在代码中表示就是，网络不可达代码为0，主机不可达代码为1，协议不可达代码为2，端口不可达代码为3，需要进行分片但设置了不分片位代码为4。</span><br><span class="line"></span><br><span class="line">第二种是源站抑制，也就是让源站放慢发送速度。	</span><br><span class="line"></span><br><span class="line">第三种是时间超时，也就是超过网络包的生存时间还是没到。</span><br><span class="line"></span><br><span class="line">第四种是路由重定向，也就是让下次发给另一个路由器。</span><br><span class="line"></span><br><span class="line">差错报文的结构相对复杂一些。除了前面还是IP，ICMP的前8字节不变，后面则跟上出错的那个IP包的IP头和IP正文的前8个字节。</span><br><span class="line"></span><br><span class="line">ping命令执行的时候，源主机首先会构建一个ICMP请求数据包，ICMP数据包内包含多个字段。最重要的是两个，第一个是类型字段，对于请求数据包而言该字段为 8；另外一个是顺序号，主要用于区分连续ping的时候发出的多个数据包。每发出一个请求数据包，顺序号会自动加1。为了能够计算往返时间RTT，它会在报文的数据部分插入发送时间。</span><br><span class="line"></span><br><span class="line">然后，由ICMP协议将这个数据包连同地址192.168.1.2一起交给IP层。IP层将以192.168.1.2作为目的地址，本机IP地址作为源地址，加上一些其他控制信息，构建一个IP数据包。</span><br><span class="line"></span><br><span class="line">Traceroute的第一个作用就是故意设置特殊的TTL，来追踪去往目的地时沿途经过的路由器。Traceroute的参数指向某个目的IP地址，它会发送一个UDP的数据包。将TTL设置成1，也就是说一旦遇到一个路由器或者一个关卡，就表示它“牺牲”了。</span><br><span class="line"></span><br><span class="line">Traceroute还有一个作用是故意设置不分片，从而确定路径的MTU。</span><br><span class="line"></span><br><span class="line">Traceroute：差错报文类型的使用。</span><br><span class="line"></span><br><span class="line">当你的宿舍长能够上网之后，接下来，就是其他人的电脑怎么上网的问题。这就需要配置你们的网卡。当然DHCP是可以默认配置的。在进行网卡配置的时候，除了IP地址，还需要配置一个Gateway的东西，这个就是网关。</span><br><span class="line"></span><br><span class="line">在MAC头里面，先是目标MAC地址，然后是源MAC地址，然后有一个协议类型，用来说明里面是IP协议。IP头里面的版本号，目前主流的还是IPv4，服务类型TOS在第三节讲ip addr命令的时候讲过，TTL在第7节讲ICMP协议的时候讲过。另外，还有8位标识协议。这里到了下一层的协议，也就是，是TCP还是UDP。最重要的就是源IP和目标IP。先是源IP地址，然后是目标IP地址。</span><br><span class="line"></span><br><span class="line">在任何一台机器上，当要访问另一个IP地址的时候，都会先判断，这个目标IP地址，和当前机器的IP地址，是否在同一个网段。怎么判断同一个网段呢？需要CIDR和子网掩码，这个在第三节的时候也讲过了。</span><br><span class="line"></span><br><span class="line">网关往往是一个路由器，是一个三层转发的设备。啥叫三层设备？前面也说过了，就是把MAC头和IP头都取下来，然后根据里面的内容，看看接下来把包往哪里转发的设备。</span><br><span class="line"></span><br><span class="line">路由器是一台设备，它有五个网口或者网卡，相当于有五只手，分别连着五个局域网。每只手的IP地址都和局域网的IP地址相同的网段，每只手都是它握住的那个局域网的网关。</span><br><span class="line"></span><br><span class="line">静态路由，其实就是在路由器上，配置一条一条规则。</span><br><span class="line"></span><br><span class="line">之前我说过，MAC地址是一个局域网内才有效的地址。因而，MAC地址只要过网关，就必定会改变，因为已经换了局域网。两者主要的区别在于IP地址是否改变。不改变IP地址的网关，我们称为转发网关；改变IP地址的网关，我们称为NAT网关。</span><br><span class="line"></span><br><span class="line">从这个过程可以看出，IP地址也会变。这个过程用英文说就是Network Address Translation，简称NAT。</span><br><span class="line"></span><br><span class="line">你可以通过 https://www.whatismyip.com/ 查看自己的出口IP地址。</span><br><span class="line"></span><br><span class="line">如果离开本局域网，就需要经过网关，网关是路由器的一个网口；</span><br><span class="line"></span><br><span class="line">路由器是一个三层设备，里面有如何寻找下一跳的规则；</span><br><span class="line"></span><br><span class="line">当一个入口的网络包送到路由器时，它会根据一个本地的转发信息库，来决定如何正确地转发流量。这个转发信息库通常被称为路由表。</span><br><span class="line"></span><br><span class="line">在大学里面学习计算机网络与数据结构的时候，知道求最短路径常用的有两种方法，一种是Bellman-Ford算法，一种是Dijkstra算法。</span><br><span class="line"></span><br><span class="line">第一大类的算法称为距离矢量路由（distance vector routing）。它是基于Bellman-Ford算法的。</span><br><span class="line"></span><br><span class="line">这种算法的第二个问题是，每次发送的时候，要发送整个全局路由表。</span><br><span class="line"></span><br><span class="line">第二大类算法是链路状态路由（link state routing），基于Dijkstra算法。</span><br><span class="line"></span><br><span class="line">OSPF（Open Shortest Path First，开放式最短路径优先）就是这样一个基于链路状态路由协议，广泛应用在数据中心中的协议。由于主要用在数据中心内部，用于路由决策，因而称为内部网关协议（Interior Gateway Protocol，简称IGP）。</span><br><span class="line"></span><br><span class="line">内部网关协议的重点就是找到最短的路径。在一个组织内部，路径最短往往最优。当然有时候OSPF可以发现多个最短的路径，可以在这多个路径中进行负载均衡，这常常被称为等价路由。</span><br><span class="line"></span><br><span class="line">基于距离矢量路由算法的BGP。</span><br><span class="line"></span><br><span class="line">但是外网的路由协议，也即国家之间的，又有所不同。我们称为外网路由协议（Border Gateway Protocol，简称BGP）。</span><br><span class="line"></span><br><span class="line">在网络世界，这一个个国家成为自治系统AS（Autonomous System）。自治系统分几种类型。</span><br><span class="line"></span><br><span class="line">Stub AS：对外只有一个连接。这类AS不会传输其他AS的包。例如，个人或者小公司的网络。</span><br><span class="line"></span><br><span class="line">Multihomed AS：可能有多个连接连到其他的AS，但是大多拒绝帮其他的AS传输包。例如一些大公司的网络。</span><br><span class="line"></span><br><span class="line">Transit AS：有多个连接连到其他的AS，并且可以帮助其他的AS传输包。例如主干网。</span><br><span class="line"></span><br><span class="line">BGP又分为两类，eBGP和iBGP。自治系统间，边界路由器之间使用eBGP广播路由。内部网络也需要访问其他的自治系统。</span><br><span class="line"></span><br><span class="line">BGP协议使用的算法是路径矢量路由协议（path-vector protocol）。它是距离矢量路由协议的升级版。</span><br><span class="line"></span><br><span class="line">路由分静态路由和动态路由，静态路由可以配置复杂的策略路由，控制转发策略；</span><br><span class="line"></span><br><span class="line">动态路由主流算法有两种，距离矢量算法和链路状态算法。基于两种算法产生两种协议，BGP协议和OSPF协议。</span><br></pre></td></tr></table></figure></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-03-13</span><i class="fa fa-tag"></i></div></div></div></div><div class="cc"><a href="http://creativecommons.org/licenses/by-sa/4.0/"><img src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png"></a></div><div class="cc_tips">本作品采用<a href="http://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a>进行许可。</div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/2019/03/09/designPattern-observerPattern/" title="设计模式 - 观察者模式">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>